name: Main CI/CD

on:
  push:
    branches: [main]

jobs:
  test-and-scan:
    permissions:
      contents: write
      packages: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci
      - run: npm run lint
      - run: npm run test:cov
      - run: npm run test:e2e
      
  release:
    needs: test-and-scan
    permissions:
      contents: write
      packages: write
      pull-requests: write
    runs-on: ubuntu-latest
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: Semantic Release
        id: semantic
        uses: cycjimmy/semantic-release-action@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-and-publish:
    needs: release
    if: needs.release.outputs.new_release_published == 'true'
    permissions:
      contents: write
      packages: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare Kaniko Config
        run: |
          mkdir -p /tmp/kaniko
          echo '{"auths":{"ghcr.io":{"auth":"'$(echo -n "${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}" | base64)'"}}}' > /tmp/kaniko/config.json

      - name: Build & Push with Kaniko
        run: |
          docker run --rm \
            -v "$PWD":/workspace \
            -v /tmp/kaniko:/kaniko/.docker \
            gcr.io/kaniko-project/executor:v1.23.2-debug \
            --context=/workspace \
            --dockerfile=/workspace/Dockerfile \
            --destination=ghcr.io/${{ github.repository_owner }}/trubanb-accommodation-service:${{ needs.release.outputs.new_release_version }} \
            --destination=ghcr.io/${{ github.repository_owner }}/trubanb-accommodation-service:latest \
            --cache=true \
            --cache-repo=ghcr.io/${{ github.repository_owner }}/trubanb-accommodation-service-cache \
            --cache-ttl=168h \
            --compressed-caching=false \
            --push-retry=3 \
            --label=org.opencontainers.image.source=https://github.com/${{ github.repository }} \
            --label=org.opencontainers.image.description="Trubanb Accommodation Service" \
            --label=org.opencontainers.image.licenses=MIT \
            --label=org.opencontainers.image.revision=${{ github.sha }} \
            --label=org.opencontainers.image.version=${{ needs.release.outputs.new_release_version }}